<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <title>æµ‹è¯•è·å– userId</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .title {
      text-align: center;
      font-size: 20px;
      color: #333;
      margin-bottom: 30px;
      font-weight: bold;
    }
    .result {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #1678ff;
    }
    .result-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .result-value {
      font-size: 16px;
      color: #333;
      font-weight: bold;
      word-break: break-all;
    }
    .success {
      border-left-color: #52c41a;
    }
    .error {
      border-left-color: #ff4d4f;
    }
    .status {
      text-align: center;
      font-size: 14px;
      color: #999;
      margin: 20px 0;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #1678ff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 5px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 5px;
      font-size: 12px;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log div {
      margin: 3px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="title">ğŸ” æµ‹è¯•è·å–æ”¯ä»˜å® UserId</div>

  <div class="status" id="status">
    <span class="loading"></span>æ­£åœ¨è·å–...
  </div>

  <!-- URL å‚æ•° -->
  <div class="result" id="urlResult" style="display:none;">
    <div class="result-title">æ–¹æ³•1ï¼šURL å‚æ•°</div>
    <div class="result-value" id="urlValue"></div>
  </div>

  <!-- getUserInfo -->
  <div class="result" id="userInfoResult" style="display:none;">
    <div class="result-title">æ–¹æ³•2ï¼šgetUserInfo()</div>
    <div class="result-value" id="userInfoValue"></div>
  </div>

  <!-- authCode -->
  <div class="result" id="authCodeResult" style="display:none;">
    <div class="result-title">æ–¹æ³•3ï¼šgetAuthCode()</div>
    <div class="result-value" id="authCodeValue"></div>
  </div>

  <!-- æœ€ç»ˆ userId -->
  <div class="result success" id="finalResult" style="display:none;">
    <div class="result-title">âœ… æœ€ç»ˆè·å–åˆ°çš„ UserId</div>
    <div class="result-value" id="finalValue" style="font-size:18px;color:#52c41a;"></div>
  </div>

  <!-- æ—¥å¿— -->
  <div class="log" id="log"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.inc.min.js"></script>

<script>
  var finalUserId = null;

  // æ—¥å¿—å‡½æ•°
  function log(msg, color) {
    console.log(msg);
    var logDiv = document.getElementById('log');
    var time = new Date().toLocaleTimeString();
    var style = color ? ' style="color:' + color + '"' : '';
    logDiv.innerHTML += '<div' + style + '>[' + time + '] ' + msg + '</div>';
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function updateStatus(msg) {
    document.getElementById('status').innerHTML = msg;
  }

  function showResult(id, value, isSuccess) {
    var element = document.getElementById(id);
    element.style.display = 'block';
    if(isSuccess) {
      element.classList.add('success');
    } else {
      element.classList.add('error');
    }
    document.getElementById(id.replace('Result', 'Value')).textContent = value;
  }

  // ========== é¡µé¢åˆå§‹åŒ– ==========
  $(document).ready(function() {
    log('========================================', '#ff0');
    log('æµ‹è¯•å¼€å§‹', '#ff0');
    log('========================================', '#ff0');
    log('é¡µé¢URL: ' + window.location.href);
    log('UserAgent: ' + navigator.userAgent);

    // æ£€æŸ¥ç¯å¢ƒ
    var isAlipay = navigator.userAgent.toLowerCase().indexOf('alipay') > -1;
    log('åœ¨æ”¯ä»˜å®å†…: ' + isAlipay, isAlipay ? '#0f0' : '#f00');

    if(!isAlipay) {
      updateStatus('âŒ è¯·åœ¨æ”¯ä»˜å®ä¸­æ‰“å¼€æ­¤é¡µé¢');
      log('é”™è¯¯ï¼šä¸åœ¨æ”¯ä»˜å®ç¯å¢ƒ', '#f00');
      return;
    }

    // å¼€å§‹æµ‹è¯•
    log('----------------------------------------', '#ff0');
    startTest();
  });

  // ========== å¼€å§‹æµ‹è¯• ==========
  function startTest() {
    // æ–¹æ³•1ï¼šæ£€æŸ¥ URL å‚æ•°
    log('æµ‹è¯•æ–¹æ³•1ï¼šæ£€æŸ¥ URL å‚æ•°');
    testUrlParams();

    // ç­‰å¾…ä¸€ä¸‹ï¼Œå†æµ‹è¯•å…¶ä»–æ–¹æ³•
    setTimeout(function() {
      log('----------------------------------------', '#ff0');
      testJSBridge();
    }, 500);
  }

  // ========== æ–¹æ³•1ï¼šURL å‚æ•° ==========
  function testUrlParams() {
    var urlParams = new URLSearchParams(window.location.search);
    var userId = urlParams.get('user_id') || urlParams.get('userId') || urlParams.get('openid');

    if(userId) {
      log('âœ… ä» URL è·å–åˆ° userId: ' + userId, '#0f0');
      showResult('urlResult', userId, true);
      finalUserId = userId;
      showFinalResult();
    } else {
      log('âŒ URL ä¸­æ²¡æœ‰ userId å‚æ•°', '#f00');
      showResult('urlResult', 'æœªæ‰¾åˆ°', false);
    }
  }

  // ========== æ–¹æ³•2 & 3ï¼šä½¿ç”¨ JSBridge ==========
  function testJSBridge() {
    function ready(cb) {
      if (window.AlipayJSBridge) {
        log('âœ… AlipayJSBridge å·²å­˜åœ¨', '#0f0');
        cb && cb();
      } else {
        log('ç­‰å¾… AlipayJSBridge...', '#ff0');
        document.addEventListener('AlipayJSBridgeReady', function() {
          log('âœ… AlipayJSBridge Ready', '#0f0');
          cb && cb();
        }, false);
      }
    }

    ready(function() {
      // å…ˆæµ‹è¯• getUserInfo
      testGetUserInfo();
    });
  }

  // ========== æµ‹è¯• getUserInfo ==========
  function testGetUserInfo() {
    log('æµ‹è¯•æ–¹æ³•2ï¼šAlipayJSBridge.call("getUserInfo")');

    try {
      AlipayJSBridge.call('getUserInfo', {}, function(result) {
        log('getUserInfo è¿”å›: ' + JSON.stringify(result));

        if(result && result.userId) {
          log('âœ… getUserInfo æˆåŠŸ: ' + result.userId, '#0f0');
          showResult('userInfoResult', result.userId, true);
          finalUserId = result.userId;
          showFinalResult();
        } else {
          log('âŒ getUserInfo æœªè¿”å› userId', '#f00');
          showResult('userInfoResult', 'APIä¸æ”¯æŒæˆ–æœªæˆæƒ', false);
        }

        // ç»§ç»­æµ‹è¯• authCode
        setTimeout(function() {
          log('----------------------------------------', '#ff0');
          testGetAuthCode();
        }, 500);
      });
    } catch(e) {
      log('âŒ getUserInfo å¼‚å¸¸: ' + e.message, '#f00');
      showResult('userInfoResult', 'å¼‚å¸¸: ' + e.message, false);

      // ç»§ç»­æµ‹è¯• authCode
      setTimeout(function() {
        log('----------------------------------------', '#ff0');
        testGetAuthCode();
      }, 500);
    }
  }

  // ========== æµ‹è¯• getAuthCode ==========
  function testGetAuthCode() {
    log('æµ‹è¯•æ–¹æ³•3ï¼šAlipayJSBridge.call("getAuthCode")');

    try {
      AlipayJSBridge.call('getAuthCode', {
        scopeNicks: ["auth_base"]
      }, function(result) {
        log('getAuthCode è¿”å›: ' + JSON.stringify(result));

        if(result && result.authCode) {
          log('âœ… getAuthCode æˆåŠŸ: ' + result.authCode, '#0f0');
          showResult('authCodeResult', result.authCode, true);

          // authCode ä¸æ˜¯çœŸå®çš„ userIdï¼Œéœ€è¦æ¢å–
          log('æ³¨æ„ï¼šauthCode éœ€è¦é€šè¿‡åç«¯æ¥å£æ¢å–çœŸå®çš„ userId', '#ff0');

          if(!finalUserId) {
            log('å°è¯•å°† authCode å‘é€åˆ°åç«¯æ¢å– userId...', '#ff0');
            // è¿™é‡Œå¯ä»¥è°ƒç”¨åç«¯æ¥å£
          }
        } else {
          log('âŒ getAuthCode å¤±è´¥', '#f00');
          showResult('authCodeResult', 'è·å–å¤±è´¥', false);
        }

        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
        setTimeout(showFinalResult, 500);
      });
    } catch(e) {
      log('âŒ getAuthCode å¼‚å¸¸: ' + e.message, '#f00');
      showResult('authCodeResult', 'å¼‚å¸¸: ' + e.message, false);
      setTimeout(showFinalResult, 500);
    }
  }

  // ========== æ˜¾ç¤ºæœ€ç»ˆç»“æœ ==========
  function showFinalResult() {
    log('========================================', '#ff0');

    if(finalUserId) {
      log('ğŸ‰ æˆåŠŸè·å–åˆ° userId: ' + finalUserId, '#0f0');
      updateStatus('âœ… æˆåŠŸè·å–åˆ° userIdï¼');
      showResult('finalResult', finalUserId, true);
    } else {
      log('âŒ æœªèƒ½è·å–åˆ°çœŸå®çš„ userId', '#f00');
      log('å¯èƒ½éœ€è¦ï¼š', '#ff0');
      log('1. ç”³è¯·æ”¯ä»˜å®åº”ç”¨ AppID', '#ff0');
      log('2. ä½¿ç”¨ authCode é€šè¿‡åç«¯æ¢å– userId', '#ff0');
      log('3. æˆ–è€…è”ç³»ç¬¬ä¸‰æ–¹å¹³å°æä¾›è§£å†³æ–¹æ¡ˆ', '#ff0');
      updateStatus('âŒ æœªèƒ½è·å–åˆ° userId');
    }

    log('========================================', '#ff0');
    log('æµ‹è¯•ç»“æŸ', '#ff0');
  }
</script>

</body>
</html>