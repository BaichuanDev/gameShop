<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
  <title>测试获取 userId</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .title {
      text-align: center;
      font-size: 20px;
      color: #333;
      margin-bottom: 30px;
      font-weight: bold;
    }
    .result {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #1678ff;
    }
    .result-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .result-value {
      font-size: 16px;
      color: #333;
      font-weight: bold;
      word-break: break-all;
    }
    .success {
      border-left-color: #52c41a;
    }
    .error {
      border-left-color: #ff4d4f;
    }
    .status {
      text-align: center;
      font-size: 14px;
      color: #999;
      margin: 20px 0;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #1678ff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 5px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .log {
      background: #000;
      color: #0f0;
      padding: 15px;
      border-radius: 5px;
      font-size: 12px;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log div {
      margin: 3px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="title">🔍 测试获取支付宝 UserId</div>

  <div class="status" id="status">
    <span class="loading"></span>正在获取...
  </div>

  <!-- URL 参数 -->
  <div class="result" id="urlResult" style="display:none;">
    <div class="result-title">方法1：URL 参数</div>
    <div class="result-value" id="urlValue"></div>
  </div>

  <!-- getUserInfo -->
  <div class="result" id="userInfoResult" style="display:none;">
    <div class="result-title">方法2：getUserInfo()</div>
    <div class="result-value" id="userInfoValue"></div>
  </div>

  <!-- authCode -->
  <div class="result" id="authCodeResult" style="display:none;">
    <div class="result-title">方法3：getAuthCode()</div>
    <div class="result-value" id="authCodeValue"></div>
  </div>

  <!-- 最终 userId -->
  <div class="result success" id="finalResult" style="display:none;">
    <div class="result-title">✅ 最终获取到的 UserId</div>
    <div class="result-value" id="finalValue" style="font-size:18px;color:#52c41a;"></div>
  </div>

  <!-- 日志 -->
  <div class="log" id="log"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.inc.min.js"></script>

<script>
  var finalUserId = null;

  // 日志函数
  function log(msg, color) {
    console.log(msg);
    var logDiv = document.getElementById('log');
    var time = new Date().toLocaleTimeString();
    var style = color ? ' style="color:' + color + '"' : '';
    logDiv.innerHTML += '<div' + style + '>[' + time + '] ' + msg + '</div>';
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function updateStatus(msg) {
    document.getElementById('status').innerHTML = msg;
  }

  function showResult(id, value, isSuccess) {
    var element = document.getElementById(id);
    element.style.display = 'block';
    if(isSuccess) {
      element.classList.add('success');
    } else {
      element.classList.add('error');
    }
    document.getElementById(id.replace('Result', 'Value')).textContent = value;
  }

  // ========== 页面初始化 ==========
  $(document).ready(function() {
    log('========================================', '#ff0');
    log('测试开始', '#ff0');
    log('========================================', '#ff0');
    log('页面URL: ' + window.location.href);
    log('UserAgent: ' + navigator.userAgent);

    // 检查环境
    var isAlipay = navigator.userAgent.toLowerCase().indexOf('alipay') > -1;
    log('在支付宝内: ' + isAlipay, isAlipay ? '#0f0' : '#f00');

    if(!isAlipay) {
      updateStatus('❌ 请在支付宝中打开此页面');
      log('错误：不在支付宝环境', '#f00');
      return;
    }

    // 开始测试
    log('----------------------------------------', '#ff0');
    startTest();
  });

  // ========== 开始测试 ==========
  function startTest() {
    // 方法1：检查 URL 参数
    log('测试方法1：检查 URL 参数');
    testUrlParams();

    // 等待一下，再测试其他方法
    setTimeout(function() {
      log('----------------------------------------', '#ff0');
      testJSBridge();
    }, 500);
  }

  // ========== 方法1：URL 参数 ==========
  function testUrlParams() {
    var urlParams = new URLSearchParams(window.location.search);
    var userId = urlParams.get('user_id') || urlParams.get('userId') || urlParams.get('openid');

    if(userId) {
      log('✅ 从 URL 获取到 userId: ' + userId, '#0f0');
      showResult('urlResult', userId, true);
      finalUserId = userId;
      showFinalResult();
    } else {
      log('❌ URL 中没有 userId 参数', '#f00');
      showResult('urlResult', '未找到', false);
    }
  }

  // ========== 方法2 & 3：使用 JSBridge ==========
  function testJSBridge() {
    function ready(cb) {
      if (window.AlipayJSBridge) {
        log('✅ AlipayJSBridge 已存在', '#0f0');
        cb && cb();
      } else {
        log('等待 AlipayJSBridge...', '#ff0');
        document.addEventListener('AlipayJSBridgeReady', function() {
          log('✅ AlipayJSBridge Ready', '#0f0');
          cb && cb();
        }, false);
      }
    }

    ready(function() {
      // 先测试 getUserInfo
      testGetUserInfo();
    });
  }

  // ========== 测试 getUserInfo ==========
  function testGetUserInfo() {
    log('测试方法2：AlipayJSBridge.call("getUserInfo")');

    try {
      AlipayJSBridge.call('getUserInfo', {}, function(result) {
        log('getUserInfo 返回: ' + JSON.stringify(result));

        if(result && result.userId) {
          log('✅ getUserInfo 成功: ' + result.userId, '#0f0');
          showResult('userInfoResult', result.userId, true);
          finalUserId = result.userId;
          showFinalResult();
        } else {
          log('❌ getUserInfo 未返回 userId', '#f00');
          showResult('userInfoResult', 'API不支持或未授权', false);
        }

        // 继续测试 authCode
        setTimeout(function() {
          log('----------------------------------------', '#ff0');
          testGetAuthCode();
        }, 500);
      });
    } catch(e) {
      log('❌ getUserInfo 异常: ' + e.message, '#f00');
      showResult('userInfoResult', '异常: ' + e.message, false);

      // 继续测试 authCode
      setTimeout(function() {
        log('----------------------------------------', '#ff0');
        testGetAuthCode();
      }, 500);
    }
  }

  // ========== 测试 getAuthCode ==========
  function testGetAuthCode() {
    log('测试方法3：AlipayJSBridge.call("getAuthCode")');

    try {
      AlipayJSBridge.call('getAuthCode', {
        scopeNicks: ["auth_base"]
      }, function(result) {
        log('getAuthCode 返回: ' + JSON.stringify(result));

        if(result && result.authCode) {
          log('✅ getAuthCode 成功: ' + result.authCode, '#0f0');
          showResult('authCodeResult', result.authCode, true);

          // authCode 不是真实的 userId，需要换取
          log('注意：authCode 需要通过后端接口换取真实的 userId', '#ff0');

          if(!finalUserId) {
            log('尝试将 authCode 发送到后端换取 userId...', '#ff0');
            // 这里可以调用后端接口
          }
        } else {
          log('❌ getAuthCode 失败', '#f00');
          showResult('authCodeResult', '获取失败', false);
        }

        // 显示最终结果
        setTimeout(showFinalResult, 500);
      });
    } catch(e) {
      log('❌ getAuthCode 异常: ' + e.message, '#f00');
      showResult('authCodeResult', '异常: ' + e.message, false);
      setTimeout(showFinalResult, 500);
    }
  }

  // ========== 显示最终结果 ==========
  function showFinalResult() {
    log('========================================', '#ff0');

    if(finalUserId) {
      log('🎉 成功获取到 userId: ' + finalUserId, '#0f0');
      updateStatus('✅ 成功获取到 userId！');
      showResult('finalResult', finalUserId, true);
    } else {
      log('❌ 未能获取到真实的 userId', '#f00');
      log('可能需要：', '#ff0');
      log('1. 申请支付宝应用 AppID', '#ff0');
      log('2. 使用 authCode 通过后端换取 userId', '#ff0');
      log('3. 或者联系第三方平台提供解决方案', '#ff0');
      updateStatus('❌ 未能获取到 userId');
    }

    log('========================================', '#ff0');
    log('测试结束', '#ff0');
  }
</script>

</body>
</html>